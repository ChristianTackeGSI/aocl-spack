Spack Overview

1.0 About Spack tool:
	Spack (https://spack.io/) is a package manager for supercomputers,
	Linux, and macOS.  It makes installing scientific software easy.
	With Spack, user can build a package with multiple versions,
	configurations, platforms, and compilers, and all these builds can
	coexist on the same machine.

Note: Step 5.0 Semi-automation approach will do step 2.0, 3.0 and 4.0 (Except
      AOCC compiler installation)

2.0 To Install Spack:
	Please refer https://spack.readthedocs.io/en/latest/getting_started.html
	link for Spack tool's:
		. Prerequisites 
		. Installation
		. Add Spack to the Shell
	Note: AOCL packages are tested using Spack release version - v0.12

3.0 To install Environment Modules:
	In order to use Spack's generated module files, user need to install
	environment-modules package, below steps will depicts the procedure.

	$ spack install environment-modules
	$ spack -i environment-modules
	$ source init/bash

4.0 To setup environment required for AOCL packages:

	4.1 AOCL Prerequisites
		Recommended compiler version for AOCL package are AOCC-2.0 and
		GCC-9.2.0

		4.1.1 Steps for adding AOCC-2.0 compiler to Spack:
			. Download AOCC-2.0 binaries from below URL
			  https://developer.amd.com/amd-aocc/
			. spack compiler find <AOCC install directory path>

		4.1.2 Steps for adding GCC-9.2.0 compiler to Spack:
			$ spack install --no-checksum gcc@9.2.0
			$ gcc_9_2_0=$(spack location --install-dir gcc@9.2.0)
			$ spack compiler find ${gcc_9_2_0}

	4.2 AOCL tar package
		aocl_spack_recipe.tar package contains below items:
			. README
			. spack_set_env.sh (Not required for manual approach)
			. spack_recipes.tar

		$ cd ${SPACK_ROOT}
		Where SPACK_ROOT value is /path/to/spack
		$ cd ../
		$ cp -v <Download Path>/spack_recipe_aocl_2.0.0.tar .
		Extract spack_recipe_aocl_2.0.0.tar tar package 
		$ tar -xf spack_recipe_aocl_2.0.0.tar

		where spack_recipes.tar package contains spack recipe for
		amd.Blis, amd.FFTW, amd.libFLAME libraries recipe along
		with spack files required for adding amd namespace

	4.3 To add AMD namespace (spack package repositories) to Spack
		We use a separate package repository for the installing AOCL 
		packages. Package repositories allow user to separate sets of
		packages that take precedence over one another. 

		We will use the amd repo that ships with spack_recipes.tar tar
		package to avoid breaking the builtin Spack packages.

		Below command will add amd namespace
			$ spack repo add ${SPACK_ROOT}/var/spack/repos/amd/

		Below command will list all the available namespaces in spack
			$ spack repo list

5.0 To setup environment required for Spack and AOCL packages by using 
    spack_set_env.sh script (Semi-automation approach):

	Bash script spack_set_env.sh which is part of spack deliverable tar
	aocl_spack_recipe.tar, will setup the environment required for AOCL
	package.

	spack_set_env.sh  script will perform below said activities:
		. Lists Spack prerequisites 
		. Downloads Spack tool (release version - v0.12)
		. Install and configure environment-modules
		. Extracts spack deliverable tar package package
		. Adding repo with namespace "amd"
		. Print the step for adding Spack to the Shell

	script usage:
		. If no Spack tool present in machine:
		$ spack_set_env.sh -t <Path of spack_recipes.tar tar package>

		. If Spack tool directory is already present in machine:
		$ spack_set_env.sh -t <Path of spack_recipes.tar tar package>
		  -s <Path of Spack path if it is already installed>

6.0 To Install AOCL packages:

	AOCL package, which consists of amd.Blis, amd.libFlame and amd.fftw can
	be installed using below procedure as shown for Blis package:

	6.1 amd.blis package (same process for amd.libFlamd and amd.fftw):
		Below command will provide blis package info and
		supported versions
			$ spack info amd.blis

		To install amd blis latest version
			$ spack install amd.blis

		To verify contents installed contents
			$ spack spec amd.blis
 
		Command to go blis install-directory
			$ spack cd -i amd.blis
 
		To install other versions of amd blis package use @
		(supported versions of blis are 2.0, 1.3, 1.2 and 1.0):
			$ spack install -v amd.blis@1.3 

		To build and install Blis which will support multithreading
		using AOCC compiler:
			$ spack install amd.blis@1.2 threads=openmp %clang@8.0.0
 

		For multithreading using AOCC compiler:
			$ spack install amd.blis@1.0 threads=pthreads %gcc@9.2.0
 

		To list all versions of blis along with "hash", "version",
		"arch", "compiler", "namespace" and "parameters" value:
			$ spack find -lvN amd.blis
 

		To use spack installed packages:
			To use, user can either call spack load <package> or
			export the path of installed package

 

		To uninstall Blis package:
			To uninstall Blis default package
				$ spack uninstall amd.blis

			To uninstall Blis based out of different version:
				$ spack uninstall amd.blis@2.0

			To uninstall Blis based out of hash values:
				$ spack uninstall amd.blis/43reafx

			To uninstall Blis based out of different namespace:
				$ spack uninstall builtin.blis@0.6.0


7.0 To switch to builtin namespace:
	To switch to builtin namespace 
		$ spack repo remove amd
		$ spack repo add </path/to/spack>/var/spack/repos/builtin
 

Note: AOCL packages based out of AMD namespaces and community libraries can
      exist together under same spack directory.
